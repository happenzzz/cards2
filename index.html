<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ì¼ë³´ë“œí˜• ìº”ë²„ìŠ¤ â€” í¬ìŠ¤íŠ¸ì‡ ì¹´ë“œ + ë¶„ë¥˜í•˜ê¸°</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#182233; --muted:#7a8599; --line:#e6e9f2;
    --card:#ffffff; --shadow:0 8px 22px rgba(0,0,0,.08);
    --radius:18px; --gap:14px; --minCell:190px;
    --dotSize:4px; --dotStep:36px;

    /* ë¶„ë¥˜ëª¨ë“œ ê³ ì • ì‚¬ì´ì¦ˆ & ì—¬ë°± */
    --classifyCell:150px;      /* ë¶„ë¥˜ëª¨ë“œ ì¹´ë“œ ê³ ì • í¬ê¸°(ì‘ê³  ì¼ì •) */
    --gutterX:36px;            /* íŒ¨ë“œì—ì„œ ì¢Œìš° ìŠ¤í¬ë¡¤ ì—¬ë°± */
    --dividerW:26px;           /* ì¤‘ì•™ ë¶„í• ì„  ë‘ê»˜ */

    /* ì¤‘ì•™ ë²„íŠ¼(í¬ê³  ëˆˆì— ë„ê²Œ) */
    --zoneBtnFont: clamp(28px, 3.6vw, 36px);  /* ê¸°ì¡´ ëŒ€ë¹„ ~2ë°° */
    --zoneBtnPadY: 14px;
    --zoneBtnPadX: 22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    -webkit-font-smoothing:antialiased;
    background:
      radial-gradient(circle at 13px 13px, #dfe6fb var(--dotSize), transparent calc(var(--dotSize) + .5px)) 0 0/var(--dotStep) var(--dotStep),
      #fff;
  }

  /* ìƒë‹¨ ë°” */
  .topbar{
    position:sticky; top:0; z-index:40; height:60px;
    display:flex; align-items:center; justify-content:flex-end; gap:10px;
    padding:10px 16px; background:linear-gradient(#fff, rgba(255,255,255,.92));
    border-bottom:1px solid var(--line); backdrop-filter:saturate(1.1) blur(4px);
  }
  .btn{
    appearance:none; border:2px solid var(--line); background:#fff; color:#0f172a;
    padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.02); letter-spacing:.2px; font-size:15px;
    transition:transform .05s, border-color .1s;
  }
  .btn:active{ transform:translateY(1px) }
  .btn:hover{border-color:#d3d9eb}

  .wrap{max-width:1200px; margin:0 auto; padding:18px}
  .grid{
    display:grid; gap:var(--gap);
    grid-template-columns:repeat(auto-fit, minmax(var(--minCell), 1fr));
    align-content:start;
  }

  /* ì¹´ë“œ(í¸ì§‘ ë¶ˆê°€) */
  .card{
    display:flex; flex-direction:column; background:var(--card);
    border:1.5px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); overflow:hidden;
    user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
    touch-action:none;
  }
  .shot{ width:100%; aspect-ratio:1/1; position:relative; overflow:hidden; background:#f6f7fb; }
  .shot img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; pointer-events:none; -webkit-user-drag:none; }
  .cap{
    padding:12px 12px; border-top:1px solid var(--line);
    font-size:15px; line-height:1.35; min-height:44px;
    -webkit-user-select:none; user-select:none;
  }

  /* ìë™ ë¡œë”© ì•ˆë‚´ */
  .overlay{
    position:fixed; inset:60px 0 0 0; display:flex; align-items:center; justify-content:center;
    pointer-events:auto; z-index:25;
    background:repeating-linear-gradient(45deg, rgba(255,255,255,.92) 0 14px, rgba(255,255,255,.97) 14px 28px);
    border-top:1px dashed #d7dce9;
  }
  .ov-card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:22px 20px; box-shadow:var(--shadow); text-align:center; max-width:560px; }
  .ov-title{font-weight:800; font-size:18px; margin-bottom:8px}
  .ov-desc{color:#64748b; line-height:1.6}
  .ov-actions{margin-top:14px; display:flex; gap:10px; justify-content:center}
  .hide{display:none !important;}

  /* ë¶„ë¥˜ ëª¨ë“œ (ë°°ê²½ ê°€ë ¤ ì¤‘ë³µ ë°©ì§€) */
  .classify{ position:fixed; inset:60px 0 0 0; z-index:30; display:none; background:#fff; }
  .classify.active{ display:block; }
  .zone-half{
    position:absolute; top:0; width:50%; height:100%;
    overflow:auto; padding:18px var(--gutterX);
  }
  .zone-left{ left:0;
    background: radial-gradient(circle at 16px 16px, rgba(244,63,94,.28) 6px, transparent 6px) 0 0/44px 44px, transparent;
  }
  .zone-right{ right:0;
    background: radial-gradient(circle at 16px 16px, rgba(59,130,246,.28) 6px, transparent 6px) 0 0/44px 44px, transparent;
  }

  /* ë¶„ë¥˜ëª¨ë“œ ê³ ì • ê·¸ë¦¬ë“œ */
  .zone-grid{
    display:grid; gap:var(--gap);
    grid-template-columns:repeat(auto-fill, minmax(var(--classifyCell), 1fr));
    padding-top:6px;
  }

  /* êµµê³  ê·€ì—¬ìš´ ë¶„í• ì„  */
  .divider{
    position:absolute; top:0; bottom:0; left:50%; width:var(--dividerW); transform:translateX(-50%);
    border-radius:24px;
    background:
      radial-gradient(circle, #f97316 5px, transparent 6px) center 14px/1px 40px repeat-y,
      linear-gradient(180deg, #c7d2fe 0%, #f5d0fe 100%);
    box-shadow:inset 0 0 0 2px rgba(0,0,0,.06);
    opacity:.98; z-index:34; pointer-events:none;
  }

  /* ë„“ì€ í•˜ì´ë¼ì´íŠ¸ */
  .zone-left.highlight, .zone-right.highlight{
    outline:5px dashed rgba(0,0,0,.15); outline-offset:-8px;
    animation:pulse 1s infinite;
  }
  .zone-left.highlight{ box-shadow:inset 0 0 0 4px rgba(244,63,94,.35); }
  .zone-right.highlight{ box-shadow:inset 0 0 0 4px rgba(59,130,246,.35); }
  @keyframes pulse{ 0%{opacity:.9} 50%{opacity:1} 100%{opacity:.9} }

  /* ë“œë˜ê·¸ ê³ ìŠ¤íŠ¸ */
  .drag-ghost{
    position:fixed; z-index:50; width:180px; pointer-events:none; opacity:.95;
    transform:translate(-50%, -50%); filter:drop-shadow(0 10px 18px rgba(0,0,0,.18));
    will-change:transform;
  }
  .dragging .card{ opacity:.85 }

  /* í´ë¦­ í™•ëŒ€ â€” ê¸€ì í¬ê²Œ(í•¨ì´ˆë¡¬ë°”íƒ•ì²´ ê³„ì—´) */
  .viewer{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60; }
  .viewer.show{ display:flex; }
  .viewer-card{ max-width:min(92vw, 1100px); max-height:86vh; background:#fff; border-radius:20px; overflow:hidden; box-shadow:0 20px 40px rgba(0,0,0,.25); display:flex; flex-direction:column; }
  .vshot{ background:#000; display:flex; align-items:center; justify-content:center; }
  .vshot img{ max-width:92vw; max-height:64vh; width:auto; height:auto; object-fit:contain; }
  .vcap{
    padding:20px 22px; border-top:1px solid #e6e9f2;
    font-size:clamp(42px, 6.6vw, 66px);
    line-height:1.2; text-align:center;
    font-family:"HCR Batang","í•¨ì´ˆë¡¬ë°”íƒ•ì²´","Batang","Times New Roman",serif;
  }
  .viewer .x{ position:absolute; top:14px; right:16px; background:#000; color:#fff; border:none; border-radius:12px; padding:10px 12px; font-size:14px; cursor:pointer; opacity:.9; }

  /* ì¤‘ì•™ ê³ ì • ë²„íŠ¼ (ë¶„ë¥˜ëª¨ë“œìš©) */
  .zone-midbtn{
    position:fixed; top:50%; transform:translate(-50%, -50%);
    z-index:36; display:flex; align-items:center; gap:10px;
    padding:var(--zoneBtnPadY) var(--zoneBtnPadX);
    font-size:var(--zoneBtnFont); font-weight:900;
    border-radius:999px; border:3px solid #e7ecfb; background:#fff;
    box-shadow:0 8px 18px rgba(0,0,0,.12);
    user-select:none; -webkit-user-select:none; cursor:default;
  }
  .zone-midbtn .emoji{ font-size:1.1em }
  .zone-midbtn.left  { left:25%; }
  .zone-midbtn.right { left:75%; }

  /* ë¶„ë¥˜ëª¨ë“œì—ì„œëŠ” ìƒë‹¨ ì‘ì€ íƒ€ì´í‹€ ìˆ¨ê¹€ */
  .classify .zone-title{ display:none !important; }

  /* Fake Fullscreen fallback */
  .fakefs { overflow:hidden; }
  .fakefs .classify{ inset:60px 0 0 0; }
  .fakefs .wrap{ position:fixed; inset:60px 0 0 0; overflow:auto; }
</style>
</head>
<body>
  <div class="topbar">
    <button id="classifyBtn" class="btn">ğŸ§­ ë¶„ë¥˜í•˜ê¸°</button>
    <button id="shuffle" class="btn">ğŸ”€ ì„ê¸°</button>
    <button id="fsBtn" class="btn" title="ì „ì²´í™”ë©´">â¤¢ ì „ì²´í™”ë©´</button>
  </div>

  <!-- ê¸°ë³¸ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
  <div id="mainWrap" class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- ë¶„ë¥˜ ëª¨ë“œ ë ˆì´ì–´ -->
  <div id="classify" class="classify" aria-hidden="true">
    <div id="zoneLeft"  class="zone-half zone-left">
      <div class="zone-title">ìì—°í™˜ê²½</div>
      <div id="zoneNatural" class="zone-grid"></div>
    </div>
    <div class="divider" aria-hidden="true"></div>
    <div id="zoneRight" class="zone-half zone-right">
      <div class="zone-title">ì¸ë¬¸í™˜ê²½</div>
      <div id="zoneHuman" class="zone-grid"></div>
    </div>

    <!-- ì¤‘ì•™ ê³ ì • ë²„íŠ¼ë“¤ -->
    <div class="zone-midbtn left" aria-hidden="true"><span class="emoji">ğŸŒ¿</span> ìì—°í™˜ê²½</div>
    <div class="zone-midbtn right" aria-hidden="true"><span class="emoji">ğŸ™ï¸</span> ì¸ë¬¸í™˜ê²½</div>
  </div>

  <!-- ìë™ ë¡œë”© ì•ˆë‚´ -->
  <div id="overlay" class="overlay hide">
    <div class="ov-card">
      <div class="ov-title">ì´ë¯¸ì§€ ëª©ë¡ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”</div>
      <div class="ov-desc">
        ì„œë²„ì—ì„œ <code>assets/</code> ëª©ë¡ì„ ì œê³µí•˜ì§€ ì•Šê±°ë‚˜ <code>list.json</code>ì´ ì—†ìŠµë‹ˆë‹¤.<br/>
        ì•„ë˜ì—ì„œ í´ë”/íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ì¹´ë“œê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.
      </div>
      <div class="ov-actions">
        <button id="pickDir" class="btn">ğŸ“ í´ë” ì„ íƒ</button>
        <button id="pickFiles" class="btn">ğŸ–¼ï¸ íŒŒì¼ ì„ íƒ</button>
      </div>
    </div>
  </div>

  <!-- í´ë¦­ í™•ëŒ€ ë·°ì–´ -->
  <div id="viewer" class="viewer" aria-hidden="true">
    <div class="viewer-card">
      <button class="x" id="viewerClose">ë‹«ê¸° âœ•</button>
      <div class="vshot"><img id="viewerImg" alt=""></div>
      <div class="vcap" id="viewerCap"></div>
    </div>
  </div>

  <!-- ìˆ¨ê¹€ ì…ë ¥ -->
  <input id="fileInput" type="file" webkitdirectory multiple accept="image/*" style="display:none" />
  <input id="multiInput" type="file" multiple accept="image/*" style="display:none" />

<script>
(() => {
  const mainWrap = document.getElementById('mainWrap');
  const grid = document.getElementById('grid');
  const shuffleBtn = document.getElementById('shuffle');
  const classifyBtn = document.getElementById('classifyBtn');
  const classifyLayer = document.getElementById('classify');
  const zoneLeft = document.getElementById('zoneLeft');
  const zoneRight = document.getElementById('zoneRight');
  const zoneNatural = document.getElementById('zoneNatural');
  const zoneHuman = document.getElementById('zoneHuman');
  const overlay = document.getElementById('overlay');
  const pickDirBtn = document.getElementById('pickDir');
  const pickFilesBtn = document.getElementById('pickFiles');
  const folderInput = document.getElementById('fileInput');
  const filesInput = document.getElementById('multiInput');
  const fsBtn = document.getElementById('fsBtn');

  const viewer = document.getElementById('viewer');
  const viewerImg = document.getElementById('viewerImg');
  const viewerCap = document.getElementById('viewerCap');
  const viewerClose = document.getElementById('viewerClose');

  const LIST_JSON_URL = 'assets/list.json';
  const MANIFEST_URL  = 'assets/manifest.json';
  const AUTOINDEX_URL = 'assets/';
  const CLASSIFY_KEY_PREFIX = 'jam-note-classify::';
  const baseName = (p) => (p||'').split('/').pop().replace(/\.[^.]+$/, '');

  let items = []; // { key, src, zone }
  let classifyMode = false;

  /* ì¹´ë“œ ìƒì„± */
  function createCardEl(item){
    const title = baseName(item.key);
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.key = item.key;
    card.innerHTML = `
      <div class="shot"><img src="${item.src}" alt="${title}" draggable="false"></div>
      <div class="cap" aria-label="${title}">${title}</div>
    `;
    // ì¼ë°˜ ëª¨ë“œ: í´ë¦­ â†’ í™•ëŒ€
    card.addEventListener('click', () => {
      if (card.__justOpened) { card.__justOpened = false; return; } // í¬ì¸í„°ì—…ì—ì„œ ì´ë¯¸ ì—´ì—ˆìœ¼ë©´ ë¬´ì‹œ
      if (!classifyMode) openViewer(item.src, title);
    });
    enableDragTap(card, item, title);
    return card;
  }

  /* ê¸°ë³¸ ê·¸ë¦¬ë“œ ë Œë” */
  function renderGrid(){
    grid.innerHTML = '';
    items.forEach(it => grid.appendChild(createCardEl(it)));
    autosize(grid);
  }

  /* ë¶„ë¥˜ëª¨ë“œ ë Œë” */
  function renderClassify(){
    zoneNatural.innerHTML = '';
    zoneHuman.innerHTML = '';
    items.forEach(it => {
      const el = createCardEl(it);
      (it.zone === 'human' ? zoneHuman : zoneNatural).appendChild(el);
    });
  }

  /* ê¸°ë³¸ ê·¸ë¦¬ë“œ ìë™ ì¶•ì†Œ */
  function autosize(container){
    const n = container.children.length;
    let cell = 200;
    if (n >= 12) cell = 170;
    if (n >= 20) cell = 150;
    if (n >= 28) cell = 130;
    if (n >= 36) cell = 120;
    document.documentElement.style.setProperty('--minCell', cell + 'px');
  }

  /* ì„ê¸° */
  shuffleBtn.addEventListener('click', () => {
    items.sort(() => Math.random() - 0.5);
    classifyMode ? renderClassify() : renderGrid();
  });

  /* ë¶„ë¥˜ ëª¨ë“œ í† ê¸€ */
  function setClassifyMode(on){
    classifyMode = on;
    if (on){
      mainWrap.style.display = 'none';
      classifyLayer.classList.add('active');
      classifyLayer.setAttribute('aria-hidden','false');
      classifyBtn.textContent = 'âœ… ë¶„ë¥˜ ëë‚´ê¸°';
      renderClassify();
    }else{
      classifyLayer.classList.remove('active');
      classifyLayer.setAttribute('aria-hidden','true');
      classifyBtn.textContent = 'ğŸ§­ ë¶„ë¥˜í•˜ê¸°';
      mainWrap.style.display = '';
      renderGrid();
    }
  }
  classifyBtn.addEventListener('click', () => setClassifyMode(!classifyMode));

  /* ===== íƒ­/í´ë¦­=í™•ëŒ€, ê¸¸ê²Œëˆ„ë¥´ê¸°/ì´ë™=ë“œë˜ê·¸ =====
     - pointerdown í›„ 180ms ì´ë‚´ì— ë–¼ë©´ "íƒ­/í´ë¦­"ìœ¼ë¡œ ê°„ì£¼ â†’ ì¦‰ì‹œ í™•ëŒ€
     - 180ms ì´ìƒ ê¸¸ê²Œ ëˆ„ë¥´ê±°ë‚˜, ì´ë™ ì„ê³„ì¹˜(6px) ì´ˆê³¼ â†’ ë“œë˜ê·¸ ì‹œì‘
  ----------------------------------------------------------------*/
  function enableDragTap(card, item, title){
    let state = null; // {id, startX, startY, armedTimer, armed, dragging, ghost, running}

    const MOVE_THRESHOLD = 6;     // px
    const HOLD_MS = 180;          // long-press to arm drag

    card.addEventListener('pointerdown', (e) => {
      if (!classifyMode) return;          // ë¶„ë¥˜ëª¨ë“œì—ì„œë§Œ ë“œë˜ê·¸/íƒ­ ì²˜ë¦¬
      if (e.button !== 0 && e.pointerType === 'mouse') return;

      const id = e.pointerId;
      card.setPointerCapture?.(id);

      state = {
        id,
        startX: e.clientX,
        startY: e.clientY,
        armed: false,
        dragging: false,
        ghost: null,
        running:false,
      };

      // ê¸¸ê²Œ ëˆ„ë¥´ë©´ ë“œë˜ê·¸ ê°€ë™
      state.armedTimer = setTimeout(() => { if(state) state.armed = true; }, HOLD_MS);

      const onMove = (ev) => {
        if (!state) return;
        const dx = ev.clientX - state.startX;
        const dy = ev.clientY - state.startY;
        const moved = Math.hypot(dx,dy) > MOVE_THRESHOLD;

        // ì´ë™ì´ ì¶©ë¶„í•˜ê±°ë‚˜ ê¸¸ê²Œ ëˆ„ë¥¸ ê²½ìš° ë“œë˜ê·¸ ì‹œì‘
        if (!state.dragging && (state.armed || moved)) {
          startDrag(card, e.clientX, e.clientY, ev.clientX, ev.clientY);
        } else if (state.dragging) {
          // ë“œë˜ê·¸ ì¤‘ì´ë©´ ê³ ìŠ¤íŠ¸ë§Œ rAFë¡œ ì´ë™
          state.x = ev.clientX; state.y = ev.clientY;
          if (!state.running){ state.running = true; requestAnimationFrame(loopDrag); }
          autoScroll(ev.clientX, ev.clientY);
        }
        ev.preventDefault();
      };

      const onUp = (ev) => {
        clearTimeoutSafe(state?.armedTimer);
        if (state && !state.dragging){
          // íƒ­/í´ë¦­ìœ¼ë¡œ ê°„ì£¼ â†’ ì¦‰ì‹œ í™•ëŒ€
          openViewer(item.src, title);
          card.__justOpened = true; // ë’¤ë”°ë¥´ëŠ” click ë¬´ì‹œ
          setTimeout(()=>{ card.__justOpened=false; }, 0);
        } else if (state && state.dragging){
          // ë“œë¡­ ì²˜ë¦¬
          const zone = pickDropWide(state.x ?? ev.clientX, state.y ?? ev.clientY);
          if (zone){
            const key = card.dataset.key;
            const it  = items.find(v => v.key === key);
            if (it){ it.zone = zone; saveZone(key, zone); }
            (zone === 'human' ? zoneHuman : zoneNatural).appendChild(card);
          }
          cleanupDrag();
        }
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        window.removeEventListener('pointercancel', onCancel);
        ev.preventDefault();
        state = null;
      };

      const onCancel = () => {
        clearTimeoutSafe(state?.armedTimer);
        if (state && state.dragging) cleanupDrag();
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        window.removeEventListener('pointercancel', onCancel);
        state = null;
      };

      const loopDrag = () => {
        if (!state || !state.dragging) return;
        state.running = false;
        state.ghost.style.left = state.x + 'px';
        state.ghost.style.top  = state.y + 'px';
        highlightDrop(state.x, state.y);
      };

      function startDrag(card0, sx, sy, cx, cy){
        if (!state || state.dragging) return;
        state.dragging = true;

        // ê³ ìŠ¤íŠ¸ ì¤€ë¹„
        const ghost = card0.cloneNode(true);
        ghost.classList.add('drag-ghost');
        const cw = Math.min(200, card0.getBoundingClientRect().width);
        ghost.style.width = cw + 'px';
        document.body.appendChild(ghost);
        state.ghost = ghost;
        state.x = cx; state.y = cy;
        document.body.classList.add('dragging');
      }

      function cleanupDrag(){
        zoneLeft.classList.remove('highlight');
        zoneRight.classList.remove('highlight');
        if (state?.ghost) state.ghost.remove();
        document.body.classList.remove('dragging');
      }

      function loopDrag(){ /* shadowed above for closure */ }

      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp, {passive:false});
      window.addEventListener('pointercancel', onCancel, {passive:false});
      e.preventDefault();
    });
  }

  function clearTimeoutSafe(t){ try{ clearTimeout(t); }catch{} }

  // í™”ë©´ì˜ ì™¼ìª½/ì˜¤ë¥¸ìª½ ì ˆë°˜ìœ¼ë¡œ ë„“ê²Œ íŒì • (ë°ìŠ¤í¬íƒ‘ì— ìœ ë¦¬)
  function pickDropWide(x,y){
    const r = classifyLayer.getBoundingClientRect();
    if (y < r.top || y > r.bottom) return null;
    const center = (r.left + r.right) / 2;
    const snap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dividerW')) || 26;
    if (x < center - snap/2) return 'natural';
    if (x > center + snap/2) return 'human';
    return (x < center ? 'natural' : 'human');
  }
  function highlightDrop(x,y){
    const z = pickDropWide(x,y);
    zoneLeft.classList.toggle('highlight',  z==='natural');
    zoneRight.classList.toggle('highlight', z==='human');
  }

  // ì¡´ ë‚´ë¶€ ìë™ ìŠ¤í¬ë¡¤
  function autoScroll(x,y){
    const zones = [zoneLeft, zoneRight];
    zones.forEach(z => {
      const r = z.getBoundingClientRect();
      if (x<r.left || x>r.right || y<r.top || y>r.bottom) return;
      const edge=60, speed=18;
      if (y - r.top < edge) z.scrollTop -= speed;
      else if (r.bottom - y < edge) z.scrollTop += speed;
    });
  }

  /* í™•ëŒ€ ë·°ì–´ */
  function openViewer(src, title){
    viewerImg.src = src;
    viewerImg.alt = title;
    viewerCap.textContent = title;
    viewer.classList.add('show');
    viewer.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
  }
  function closeViewer(){
    viewer.classList.remove('show');
    viewer.setAttribute('aria-hidden','true');
    viewerImg.src = '';
    document.body.style.overflow='';
  }
  viewer.addEventListener('click', (e)=>{ if (e.target === viewer) closeViewer(); });
  viewerClose.addEventListener('click', closeViewer);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeViewer(); });

  /* ì „ì²´í™”ë©´ í† ê¸€ (fallback í¬í•¨) */
  fsBtn.addEventListener('click', async () => {
    try{
      if (!document.fullscreenElement){
        if (document.documentElement.requestFullscreen){
          await document.documentElement.requestFullscreen();
        } else {
          document.body.classList.add('fakefs');
        }
        fsBtn.textContent = 'â¤¡ ì „ì²´í™”ë©´ í•´ì œ';
      }else{
        await document.exitFullscreen?.();
        document.body.classList.remove('fakefs');
        fsBtn.textContent = 'â¤¢ ì „ì²´í™”ë©´';
      }
    }catch{
      document.body.classList.toggle('fakefs');
      fsBtn.textContent = document.body.classList.contains('fakefs') ? 'â¤¡ ì „ì²´í™”ë©´ í•´ì œ' : 'â¤¢ ì „ì²´í™”ë©´';
    }
  });
  document.addEventListener('fullscreenchange', () => {
    fsBtn.textContent = document.fullscreenElement ? 'â¤¡ ì „ì²´í™”ë©´ í•´ì œ' : 'â¤¢ ì „ì²´í™”ë©´';
  });

  /* ë°ì´í„° ë¡œë”© */
  async function loadAll(){
    if (await tryListJson()) return;
    if (await tryManifest()) return;
    if (await tryAutoindex()) return;
    showOverlay();
  }
  async function tryListJson(){
    try{
      const res = await fetch(LIST_JSON_URL, {cache:'no-store'});
      if(!res.ok) throw 0;
      const data = await res.json();
      const files = Array.isArray(data) ? data : (data.images || []);
      if(!files.length) throw 0;
      items = files
        .filter(p => /\.(jpe?g|png|webp|gif)$/i.test(String(p)))
        .map(p => {
          const key = String(p).replace(/^\.?\/*assets\//,'');
          return { key, src: 'assets/' + key, zone: loadZone(key) };
        });
      renderGrid();
      return true;
    }catch{ return false; }
  }
  async function tryManifest(){
    try{
      const res = await fetch(MANIFEST_URL, {cache:'no-store'});
      if(!res.ok) throw 0;
      const data = await res.json();
      const files = Array.isArray(data) ? data : (data.images || []);
      if(!files.length) throw 0;
      items = files
        .filter(p => /\.(jpe?g|png|webp|gif)$/i.test(String(p)))
        .map(p => {
          const key = String(p).replace(/^\.?\/*assets\//,'');
          return { key, src: 'assets/' + key, zone: loadZone(key) };
        });
      renderGrid();
      return true;
    }catch{ return false; }
  }
  async function tryAutoindex(){
    try{
      const res = await fetch(AUTOINDEX_URL, {cache:'no-store'});
      if(!res.ok) throw 0;
      const html = await res.text();
      const hrefs = [...html.matchAll(/href="([^"]+\.(?:jpe?g|png|webp|gif))"/gi)].map(m => m[1]);
      const unique = Array.from(new Set(hrefs)).filter(h => !h.endsWith('/'));
      if (!unique.length) throw 0;
      items = unique.map(p => {
        const name = decodeURIComponent(p.split('/').pop());
        return { key: name, src: 'assets/' + name, zone: loadZone(name) };
      });
      renderGrid();
      return true;
    }catch{ return false; }
  }

  /* ë¡œì»¬ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° */
  function saveZone(key, zone){ try{ localStorage.setItem(CLASSIFY_KEY_PREFIX + key, zone); }catch{} }
  function loadZone(key){ try{ return localStorage.getItem(CLASSIFY_KEY_PREFIX + key) || 'pool'; }catch{ return 'pool'; } }

  /* í´ë”/íŒŒì¼ ì„ íƒ */
  function showOverlay(){ overlay.classList.remove('hide'); }
  function hideOverlay(){ overlay.classList.add('hide'); }

  pickDirBtn.addEventListener('click', async () => {
    if (window.showDirectoryPicker){
      try{
        const dir = await window.showDirectoryPicker({id:'assets-picker', mode:'read'});
        const out = [];
        for await (const entry of dir.values()){ await collectFiles(entry, out); }
        if (!out.length) return;
        items = out;
        hideOverlay(); renderGrid();
      }catch{}
      return;
    }
    folderInput.click();
  });
  pickFilesBtn.addEventListener('click', () => filesInput.click());

  async function collectFiles(handle, out){
    if (handle.kind === 'file'){
      const f = await handle.getFile();
      if (!/^image\//.test(f.type)) return;
      out.push({ key:f.name, src: URL.createObjectURL(f), zone: loadZone(f.name) });
    } else if (handle.kind === 'directory'){
      for await (const entry of handle.values()){ await collectFiles(entry, out); }
    }
  }
  folderInput.addEventListener('change', (e) => {
    const files = [...e.target.files].filter(f => /^image\//.test(f.type));
    if (!files.length) return;
    items = files.map(f => ({ key:f.name, src:URL.createObjectURL(f), zone:loadZone(f.name) }));
    hideOverlay(); renderGrid();
  });
  filesInput.addEventListener('change', (e) => {
    const files = [...e.target.files].filter(f => /^image\//.test(f.type));
    if (!files.length) return;
    items = files.map(f => ({ key:f.name, src:URL.createObjectURL(f), zone:loadZone(f.name) }));
    hideOverlay(); renderGrid();
  });

  // ì‹œì‘
  loadAll();
})();
</script>
</body>
</html>
